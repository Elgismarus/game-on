<!doctype html>
<html>
  <head>
    <title>Foos Notifier</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
	  html {height:100%;}
      body { font: 13px Comic Sans MS, Arial; height:100%; overflow:hidden;}
	  canvas {margin: 20px;}
	  button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      div#controls { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 5; padding: 10px; width: 50%; margin-right: .5%; }
	  input#name {border: 5; padding: 10px; width: 20%; margin-right: .5%; }
      .label {font: 13px Comic Sans MS, Arial; color:white;}
	  button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
	  #messages { list-style-type: none; margin: 0; padding: 0; overflow-y:scroll; height:40%;}
	  #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
	
	<!--meta http-equiv="refresh" content="5" -->
	
  </head>
	  
  <body>

	<canvas id="canvas1" width="800" height="400" style="background-color:#efefef">
		Canvas not supported!
	</canvas>

	<ul id="messages"></ul>

	<div id="controls">
		<form action="">
		  <span class="label">Message:</span><input id="msg" autocomplete="off" /><button>Send</button>
		</form>
		
		<span class="label">Name:</span>
		<input id="name" autocomplete="off" />
		<button id="addPlayer">
			Notify me!
		</button>
		<button id="clearTable">
			Clear Table!
		</button>
		<br/>
		<input type="checkbox" id="notifystart" checked="true" >
		<label for="checkbox" class="label">Notify me when the first person requests a game.</label>
	</div>

	
	<!---------------------     JAVASCRIPT     ----------------------->
	
	<script src="/socket.io/socket.io.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script>

	$(function () {
	
		//Socket.IO stuff
		var socket = io();
		$('form').submit(function()
		{
			var chatmsg = $('input#name').val() + " said: " + $('#msg').val();
			chatmsg = new Date().toLocaleTimeString() + " - " + chatmsg;
			socket.emit('chat', chatmsg);
			$('#msg').val('');
			return false;
		});
		
		socket.on('chat', function(msg)
		{
			$('#messages').append($('<li>').text(msg));
			$('#messages').scrollTop($('#messages')[0].scrollHeight) ;
			//drawTable(data);
		});

		socket.on('startTable', function(data)
		{
			if($('input#notifystart').is(':checked'))notifyMe("New Table");
		});
		
		socket.on('drawTable', function(data)
		{
			updateTable(data);
		});
		
		socket.on('updateTable', function(data)
		{
			updateTable(data);
			if(data.length === 0)
			{
				var litext = "New table";
			}
			else
			{
				
				var litext = "New player joined";
			}
			//litext = litext + " @ " + new Date().toLocaleString();
			litext = new Date().toLocaleTimeString() + " - " + litext;
			$('#messages').append($('<li>').text(litext));
		});
		
		socket.on('fullTable', function(data){
			alert("Table is already full. Use the Clear button to start fresh.")
		});
		
		
		//Hook up UI buttons to socket events
		var clearButton = $("#clearTable");
		clearButton.click(clearTable);
		
			
		function clearTable()
		{
			socket.emit('clearTable');
		}
		
		var addPlayerButton = $("#addPlayer");
		addPlayerButton.click(addPlayer);
				
		function addPlayer()
		{
			var inputname = $('input#name').val() + "";
			if(inputname=="") 
			{
				alert(inputname + " is not a valid name");
				return;
			}
			var data = [{"name":inputname}];
			socket.emit('addPlayer', data );
		}
				
		function updateTable(players)
		{

		//Canvas Stuff
			var canvas = $("#canvas1")[0]
			var ctx = canvas.getContext('2d');
			
			//Draw Table
			var tablebg = new Image();
			tablebg.onload = function() {
			drawImage(tablebg);
			};
			tablebg.src = '/images/foostable.png';
			
			if(players != undefined && players.length === 4 ) notifyMe("Game On!");
		
			function drawImage(img) 
			{
				var destX = 0;
				var destY = 0;
				var destWidth = 800;
				var destHeight = 400;
				
				ctx.drawImage(img, destX, destY, destWidth, destHeight);
				
				
				if(players != undefined)
				{
					//drawGridLines();
					
					for (var i = 0; i < players.length; i++)
					addPlayerCanvas(players[i].name, i+1);
				}
			}
			
			function drawGridLines()
			{
				ctx.fillStyle = 'red';
				ctx.strokeStyle = 'yellow';
				ctx.lineWidth=5;
				
				ctx.beginPath();
				ctx.moveTo(0,200);
				ctx.lineTo(800,200);
				ctx.stroke();
				
				ctx.beginPath();
				ctx.moveTo(400,0);
				ctx.lineTo(400,400);
				ctx.stroke();
			}
		}
		
		function addPlayerCanvas(playerName, num)
		{
		
			var strokeArgs = [];
			switch(num) {
				case 1:
					strokeArgs = [40,120];
					break;
				case 2:
					strokeArgs = [440,120];
					break;
				case 3:
					strokeArgs = [40,300];
					break;
				case 4:
					strokeArgs = [440,300];
					break;
				default:
					strokeArgs = ["Bad Data passed to addPlayerCanvas",100,200];
			}
		
			var canvas = $("#canvas1")[0]
			var ctx = canvas.getContext('2d');

			ctx.font="48px Comic Sans MS";
			// Create gradient
			var gradient=ctx.createLinearGradient(0,0,0,canvas.height);
			gradient.addColorStop("0","red");
			gradient.addColorStop("0.5","darkblue");
					
			ctx.strokeStyle=gradient;
			ctx.lineWidth=3;	
			
			ctx.strokeText(playerName,strokeArgs[0],strokeArgs[1]);
		}

		//Browser Desktop Notifications
		function notifyMe(msg) 
		{
			if (!Notification) 
			{
				alert('Desktop notifications not available in your browser. Try Chrome or Firefox.'); 
				return;
			}		
		
		// request permission on page load
			document.addEventListener('DOMContentLoaded', function () {
				if (Notification.permission !== "granted")
					Notification.requestPermission();
			});


		  if (Notification.permission !== "granted")
			Notification.requestPermission();
		  else {
			var notification = new Notification('Foosball', {
			  icon: '/images/foos.png',
			  body: msg,
			});

			notification.onclick = function () {
			  console.log("Notification clicked!");      
			};
		  }
		}
	});
	</script>
	
	</body>
  
  
  <!-- NOTES
  
  
  Phase 1:
	Browse to the page 
	Current names are rendered
	Prompted to enter name and press go!
	Name is added to the pitch
	If 4 names launch notification
	On each notification for "ted"
		update canvas with "ted ready"
		Phase 2: send notify to others that ted is ready 
  
	Clear button to reset game
  Phase 2
	Clear button notifies all that pitch was cleared
  
  Phase 3
  
  -->
  
</html>
    